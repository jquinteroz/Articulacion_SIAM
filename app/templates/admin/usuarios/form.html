{% extends "admin/base_admin.html" %}

{% block title %}{{ 'Editar' if usuario else 'Crear' }} Usuario - Admin{% endblock %}

{% block content %}

<!-- Header Section - Estilo limpio y profesional -->
<div class="bg-sena-green rounded-xl md:rounded-2xl shadow-lg p-4 md:p-8 mb-6 md:mb-8">
    <!-- Breadcrumb -->
    <nav class="text-white/80 text-xs md:text-sm mb-3 md:mb-4 flex items-center flex-wrap">
        <a href="{{ url_for('admin.dashboard') }}" class="hover:text-white transition-colors flex items-center">
            <i class="fas fa-home mr-1"></i> Dashboard
        </a>
        <span class="mx-2">/</span>
        <a href="{{ url_for('admin.usuarios') }}" class="hover:text-white transition-colors">
            Usuarios
        </a>
        <span class="mx-2">/</span>
        <span class="text-white font-semibold">{{ 'Editar' if usuario else 'Crear' }}</span>
    </nav>
    
    <!-- T√≠tulo -->
    <h1 class="text-2xl md:text-4xl font-bold text-white mb-1 md:mb-2 flex items-center">
        <i class="fas fa-{% if usuario %}user-edit{% else %}user-plus{% endif %} mr-2 md:mr-3"></i>
        {{ 'Editar Usuario' if usuario else 'Crear Nuevo Usuario' }}
    </h1>
    <p class="text-sm md:text-lg text-white/90">
        {% if usuario %}
        Modifique la informaci√≥n del usuario en el sistema
        {% else %}
        Complete el formulario para agregar un nuevo usuario
        {% endif %}
    </p>
</div>

<!-- Form Container -->
<form method="POST" id="usuarioForm" class="space-y-4 md:space-y-6">

    <!-- Secci√≥n: Informaci√≥n Personal -->
    <div class="bg-white rounded-xl md:rounded-2xl shadow-lg overflow-hidden">
        <div class="bg-gradient-to-r from-sena-green to-sena-green-dark px-4 md:px-6 py-3 md:py-4 flex items-center">
            <div class="w-8 h-8 md:w-10 md:h-10 bg-white/20 rounded-lg flex items-center justify-center mr-2 md:mr-3">
                <i class="fas fa-user text-white text-base md:text-lg"></i>
            </div>
            <h3 class="text-base md:text-xl font-bold text-white">Informaci√≥n Personal</h3>
        </div>
        <div class="p-4 md:p-6 space-y-4 md:space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
                <div>
                    <label for="tipo_documento" class="block text-sm font-semibold text-gray-700 mb-2">
                        <i class="fas fa-id-card text-sena-green mr-1"></i> Tipo de Documento
                        <span class="text-red-500">*</span>
                    </label>
                    <select name="tipo_documento" id="tipo_documento" class="w-full px-3 md:px-4 py-2 md:py-3 border-2 border-gray-200 rounded-lg md:rounded-xl focus:ring-2 focus:ring-sena-green focus:border-sena-green transition-all duration-200 outline-none bg-gray-50 text-sm md:text-base" required>
                        <option value="CC" {% if usuario and usuario.tipo_documento == 'CC' %}selected{% endif %}>C√©dula de Ciudadan√≠a</option>
                        <option value="TI" {% if usuario and usuario.tipo_documento == 'TI' %}selected{% endif %}>Tarjeta de Identidad</option>
                        <option value="CE" {% if usuario and usuario.tipo_documento == 'CE' %}selected{% endif %}>C√©dula de Extranjer√≠a</option>
                        <option value="PEP" {% if usuario and usuario.tipo_documento == 'PEP' %}selected{% endif %}>PEP</option>
                        <option value="PPT" {% if usuario and usuario.tipo_documento == 'PPT' %}selected{% endif %}>PPT</option>
                    </select>
                </div>

                <div>
                    <label for="documento" class="block text-sm font-semibold text-gray-700 mb-2">
                        <i class="fas fa-hashtag text-sena-green mr-1"></i> N√∫mero de Documento
                        <span class="text-red-500">*</span>
                    </label>
                    <input type="text"
                           name="documento"
                           id="documento"
                           class="w-full px-3 md:px-4 py-2 md:py-3 border-2 border-gray-200 rounded-lg md:rounded-xl focus:ring-2 focus:ring-sena-green focus:border-sena-green transition-all duration-200 outline-none text-sm md:text-base {% if usuario %}bg-gray-100 cursor-not-allowed{% else %}bg-gray-50{% endif %}"
                           value="{{ usuario.documento if usuario else '' }}"
                           required
                           maxlength="20"
                           {% if usuario %}readonly{% endif %}>
                    {% if usuario %}
                    <small class="text-xs md:text-sm text-gray-500 mt-1 flex items-center">
                        <i class="fas fa-info-circle mr-1"></i> El documento no se puede modificar
                    </small>
                    {% endif %}
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
                <div>
                    <label for="nombres" class="block text-sm font-semibold text-gray-700 mb-2">
                        <i class="fas fa-signature text-sena-green mr-1"></i> Nombres
                        <span class="text-red-500">*</span>
                    </label>
                    <input type="text"
                           name="nombres"
                           id="nombres"
                           class="w-full px-3 md:px-4 py-2 md:py-3 border-2 border-gray-200 rounded-lg md:rounded-xl focus:ring-2 focus:ring-sena-green focus:border-sena-green transition-all duration-200 outline-none bg-gray-50 text-sm md:text-base"
                           value="{{ usuario.nombres if usuario else '' }}"
                           required
                           maxlength="100"
                           placeholder="Nombres completos">
                </div>

                <div>
                    <label for="apellidos" class="block text-sm font-semibold text-gray-700 mb-2">
                        <i class="fas fa-signature text-sena-green mr-1"></i> Apellidos
                        <span class="text-red-500">*</span>
                    </label>
                    <input type="text"
                           name="apellidos"
                           id="apellidos"
                           class="w-full px-3 md:px-4 py-2 md:py-3 border-2 border-gray-200 rounded-lg md:rounded-xl focus:ring-2 focus:ring-sena-green focus:border-sena-green transition-all duration-200 outline-none bg-gray-50 text-sm md:text-base"
                           value="{{ usuario.apellidos if usuario else '' }}"
                           required
                           maxlength="100"
                           placeholder="Apellidos completos">
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6">
                <div>
                    <label for="fecha_nacimiento" class="block text-sm font-semibold text-gray-700 mb-2">
                        <i class="fas fa-calendar-alt text-sena-green mr-1"></i> Fecha de Nacimiento
                        {% if usuario and usuario.rol == 'APRENDIZ' %}<span class="text-red-500">*</span>{% endif %}
                    </label>
                    <input type="date"
                           name="fecha_nacimiento"
                           id="fecha_nacimiento"
                           class="w-full px-3 md:px-4 py-2 md:py-3 border-2 border-gray-200 rounded-lg md:rounded-xl focus:ring-2 focus:ring-sena-green focus:border-sena-green transition-all duration-200 outline-none bg-gray-50 text-sm md:text-base"
                           value="{{ usuario.fecha_nacimiento.strftime('%Y-%m-%d') if usuario and usuario.fecha_nacimiento else '' }}"
                           max="{{ today }}"
                           {% if usuario and usuario.rol == 'APRENDIZ' %}required{% endif %}
                           placeholder="Seleccione la fecha">
                    <small class="text-xs md:text-sm text-gray-500 mt-1 flex items-center">
                        <i class="fas fa-info-circle mr-1"></i> {% if usuario %}Solo admin/docente pueden modificar este campo{% else %}Requerido para aprendices{% endif %}
                    </small>
                </div>

                <div>
                    <label for="email" class="block text-sm font-semibold text-gray-700 mb-2">
                        <i class="fas fa-envelope text-sena-green mr-1"></i> Correo Electr√≥nico
                        <span class="text-red-500">*</span>
                    </label>
                    <input type="email"
                           name="email"
                           id="email"
                           class="w-full px-3 md:px-4 py-2 md:py-3 border-2 border-gray-200 rounded-lg md:rounded-xl focus:ring-2 focus:ring-sena-green focus:border-sena-green transition-all duration-200 outline-none bg-gray-50 text-sm md:text-base"
                           value="{{ usuario.email if usuario else '' }}"
                           required
                           maxlength="150"
                           placeholder="correo@ejemplo.com">
                </div>

                <div>
                    <label for="telefono" class="block text-sm font-semibold text-gray-700 mb-2">
                        <i class="fas fa-phone text-sena-green mr-1"></i> Tel√©fono
                    </label>
                    <input type="tel"
                           name="telefono"
                           id="telefono"
                           class="w-full px-3 md:px-4 py-2 md:py-3 border-2 border-gray-200 rounded-lg md:rounded-xl focus:ring-2 focus:ring-sena-green focus:border-sena-green transition-all duration-200 outline-none bg-gray-50 text-sm md:text-base"
                           value="{{ usuario.telefono if usuario else '' }}"
                           maxlength="20"
                           placeholder="3001234567">
                </div>
            </div>
        </div>
    </div>

    <!-- Secci√≥n: Rol y Acceso -->
    <div class="bg-white rounded-xl md:rounded-2xl shadow-lg overflow-hidden">
        <div class="bg-gradient-to-r from-sena-green-dark to-sena-green px-4 md:px-6 py-3 md:py-4 flex items-center">
            <div class="w-8 h-8 md:w-10 md:h-10 bg-white/20 rounded-lg flex items-center justify-center mr-2 md:mr-3">
                <i class="fas fa-user-shield text-white text-base md:text-lg"></i>
            </div>
            <h3 class="text-base md:text-xl font-bold text-white">Rol y Acceso</h3>
        </div>
        <div class="p-4 md:p-6 space-y-4 md:space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
                <div>
                    <label for="rol" class="block text-sm font-semibold text-gray-700 mb-2">
                        <i class="fas fa-user-tag text-sena-green mr-1"></i> Rol del Usuario
                        <span class="text-red-500">*</span>
                    </label>
                    <select name="rol" id="rol" class="w-full px-3 md:px-4 py-2 md:py-3 border-2 border-gray-200 rounded-lg md:rounded-xl focus:ring-2 focus:ring-sena-green focus:border-sena-green transition-all duration-200 outline-none bg-gray-50 text-sm md:text-base" required>
                        <option value="">Seleccione un rol...</option>
                        <option value="APRENDIZ" {% if usuario and usuario.rol == 'APRENDIZ' %}selected{% endif %}>
                            üë®‚Äçüéì Aprendiz
                        </option>
                        <option value="DOCENTE" {% if usuario and usuario.rol == 'DOCENTE' %}selected{% endif %}>
                            üë®‚Äçüè´ Docente Enlace
                        </option>
                        <option value="ADMINISTRADOR" {% if usuario and usuario.rol == 'ADMINISTRADOR' %}selected{% endif %}>
                            üõ°Ô∏è Administrador
                        </option>
                        <option value="RECTOR" {% if usuario and usuario.rol == 'RECTOR' %}selected{% endif %}>
                            üëî Rector
                        </option>
                    </select>
                    <small class="text-xs md:text-sm text-gray-500 mt-1 flex items-center">
                        <i class="fas fa-info-circle mr-1"></i>
                        Aprendiz: Estudiante | Docente: Profesor enlace | Admin: Control total | Rector: Direcci√≥n
                    </small>
                </div>

                <div>
                    <label for="activo" class="block text-sm font-semibold text-gray-700 mb-2">
                        <i class="fas fa-toggle-on text-sena-green mr-1"></i> Estado del Usuario
                    </label>
                    <div class="flex items-center space-x-3 bg-gray-50 p-4 rounded-xl border-2 border-gray-200">
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox"
                                   name="activo"
                                   id="activo"
                                   class="sr-only peer"
                                   {% if not usuario or usuario.activo %}checked{% endif %}>
                            <div class="w-14 h-7 bg-gray-300 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-sena-green/30 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-sena-green"></div>
                        </label>
                        <span class="text-sm font-medium text-gray-700" id="toggleLabel">
                            {{ 'Usuario Activo' if not usuario or usuario.activo else 'Usuario Inactivo' }}
                        </span>
                    </div>
                    <small class="text-sm text-gray-500 mt-1 flex items-center">
                        <i class="fas fa-info-circle mr-1"></i>
                        Los usuarios inactivos no pueden acceder al sistema
                    </small>
                </div>
            </div>

            <!-- Campos para APRENDIZ (Colegio, Grupo, Programa) -->
            {% if usuario and usuario.rol == 'APRENDIZ' %}
            <div id="aprendizInfoRow" class="space-y-6 mt-6 border-t-2 border-gray-100 pt-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="colegio_id" class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-school text-sena-green mr-1"></i> Colegio Asignado
                        </label>
                        <select name="colegio_id" id="colegio_id" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-sena-green focus:border-sena-green transition-all duration-200 outline-none bg-gray-50">
                            <option value="">Sin asignar</option>
                            {% for colegio in colegios %}
                            <option value="{{ colegio.id }}"
                                {% if usuario.aprendiz and usuario.aprendiz.colegio_id == colegio.id %}selected{% endif %}>
                                {{ colegio.nombre }}
                            </option>
                            {% endfor %}
                        </select>
                        <small class="text-sm text-gray-500 mt-1 flex items-center">
                            <i class="fas fa-info-circle mr-1"></i>
                            El colegio al que pertenece el aprendiz
                        </small>
                    </div>

                    <div>
                        <label for="programa_id" class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-book text-sena-green mr-1"></i> Programa Asignado
                        </label>
                        <select name="programa_id" id="programa_id" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-sena-green focus:border-sena-green transition-all duration-200 outline-none bg-gray-50">
                            <option value="">Sin asignar</option>
                            {% for programa in programas %}
                            <option value="{{ programa.id }}"
                                {% if usuario.aprendiz and usuario.aprendiz.programa_id == programa.id %}selected{% endif %}>
                                {{ programa.nombre }} ({{ programa.codigo }})
                            </option>
                            {% endfor %}
                        </select>
                        <small class="text-sm text-gray-500 mt-1 flex items-center">
                            <i class="fas fa-info-circle mr-1"></i>
                            El programa de formaci√≥n del aprendiz
                        </small>
                    </div>
                </div>

                <div id="grupoAprendizRow">
                    <label for="grupo_id" class="block text-sm font-semibold text-gray-700 mb-2">
                        <i class="fas fa-users text-sena-green mr-1"></i> Grupo/Ficha Asignada
                    </label>
                    <select name="grupo_id" id="grupo_id" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-sena-green focus:border-sena-green transition-all duration-200 outline-none bg-gray-50">
                        <option value="">Sin asignar</option>
                        {% for grupo in grupos %}
                        <option value="{{ grupo.id }}"
                            data-colegio="{{ grupo.colegio_id }}"
                            {% if usuario.aprendiz and usuario.aprendiz.grupo_id == grupo.id %}selected{% endif %}>
                            {{ grupo.nombre }} - {{ grupo.colegio.nombre }}
                        </option>
                        {% endfor %}
                    </select>
                    <small class="text-sm text-gray-500 mt-1 flex items-center">
                        <i class="fas fa-info-circle mr-1"></i>
                        La ficha o grupo al que pertenece el aprendiz
                    </small>
                </div>
            </div>
            {% endif %}

            <!-- Campo de Colegio (para DOCENTE) -->
            <div id="colegioDocenteRow" class="mt-6 border-t-2 border-gray-100 pt-6" style="display: none;">
                <label for="colegio_docente_id" class="block text-sm font-semibold text-gray-700 mb-2">
                    <i class="fas fa-school text-sena-green mr-1"></i> Colegio Asignado (Docente Enlace)
                </label>
                {% if usuario %}
                {% set colegio_actual = colegios | selectattr('docente_enlace_id', 'equalto', usuario.id) | first %}
                {% endif %}
                <select name="colegio_docente_id" id="colegio_docente_id" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-sena-green focus:border-sena-green transition-all duration-200 outline-none bg-gray-50">
                    <option value="">Sin asignar</option>
                    {% for colegio in colegios %}
                    <option value="{{ colegio.id }}"
                        {% if usuario and colegio_actual and colegio.id == colegio_actual.id %}selected{% endif %}>
                        {{ colegio.nombre }}
                        {% if usuario and colegio.docente_enlace_id and colegio.docente_enlace_id != usuario.id %}
                            (Ya tiene docente enlace asignado)
                        {% elif not usuario and colegio.docente_enlace_id %}
                            (Ya tiene docente enlace asignado)
                        {% endif %}
                    </option>
                    {% endfor %}
                </select>
                <small class="text-sm text-gray-500 mt-1 flex items-center">
                    <i class="fas fa-info-circle mr-1"></i>
                    El colegio donde este docente ser√° el enlace con el SENA
                </small>
            </div>

            <!-- Campo de Colegio (para RECTOR) -->
            <div id="colegioRectorRow" class="mt-6 border-t-2 border-gray-100 pt-6" style="display: none;">
                <label for="colegio_rector_id" class="block text-sm font-semibold text-gray-700 mb-2">
                    <i class="fas fa-school text-sena-green mr-1"></i> Colegio Asignado (Rector)
                </label>
                {% if usuario %}
                {% set colegio_actual_rector = colegios | selectattr('rector_id', 'equalto', usuario.id) | first %}
                {% endif %}
                <select name="colegio_rector_id" id="colegio_rector_id" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-sena-green focus:border-sena-green transition-all duration-200 outline-none bg-gray-50">
                    <option value="">Sin asignar</option>
                    {% for colegio in colegios %}
                    <option value="{{ colegio.id }}"
                        {% if usuario and colegio_actual_rector and colegio.id == colegio_actual_rector.id %}selected{% endif %}>
                        {{ colegio.nombre }}
                        {% if usuario and colegio.rector_id and colegio.rector_id != usuario.id %}
                            (Ya tiene rector asignado)
                        {% elif not usuario and colegio.rector_id %}
                            (Ya tiene rector asignado)
                        {% endif %}
                    </option>
                    {% endfor %}
                </select>
                <small class="text-sm text-gray-500 mt-1 flex items-center">
                    <i class="fas fa-info-circle mr-1"></i>
                    El colegio donde esta persona es rector(a)
                </small>
            </div>
        </div>
    </div>

    <!-- Secci√≥n: Contrase√±a -->
    <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
        <div class="bg-gradient-to-r from-sena-green-darker to-sena-green-dark px-6 py-4 flex items-center">
            <div class="w-10 h-10 bg-white/20 rounded-lg flex items-center justify-center mr-3">
                <i class="fas fa-key text-white text-lg"></i>
            </div>
            <h3 class="text-xl font-bold text-white">
                {% if usuario %}
                Cambiar Contrase√±a (Opcional)
                {% else %}
                Contrase√±a
                {% endif %}
            </h3>
        </div>
        <div class="p-6 space-y-6">
            {% if usuario %}
            <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-lg flex items-start">
                <i class="fas fa-info-circle text-blue-600 text-lg mr-3 mt-0.5"></i>
                <span class="text-sm text-blue-800">Deja estos campos en blanco si no deseas cambiar la contrase√±a actual</span>
            </div>
            {% endif %}

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="password" class="block text-sm font-semibold text-gray-700 mb-2">
                        <i class="fas fa-lock text-sena-green mr-1"></i> {{ 'Nueva ' if usuario else '' }}Contrase√±a
                        {% if not usuario %}<span class="text-red-500">*</span>{% endif %}
                    </label>
                    <input type="password"
                           name="password"
                           id="password"
                           class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-sena-green focus:border-sena-green transition-all duration-200 outline-none bg-gray-50"
                           {% if not usuario %}required{% endif %}
                           minlength="6"
                           placeholder="M√≠nimo 6 caracteres">
                    <small class="text-sm text-gray-500 mt-1 flex items-center">
                        <i class="fas fa-shield-alt mr-1"></i> M√≠nimo 6 caracteres
                    </small>
                </div>

                <div>
                    <label for="password_confirm" class="block text-sm font-semibold text-gray-700 mb-2">
                        <i class="fas fa-lock text-sena-green mr-1"></i> Confirmar {{ 'Nueva ' if usuario else '' }}Contrase√±a
                        {% if not usuario %}<span class="text-red-500">*</span>{% endif %}
                    </label>
                    <input type="password"
                           name="password_confirm"
                           id="password_confirm"
                           class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-sena-green focus:border-sena-green transition-all duration-200 outline-none bg-gray-50"
                           {% if not usuario %}required{% endif %}
                           minlength="6"
                           placeholder="Repita la contrase√±a">
                </div>
            </div>
        </div>
    </div>

    <!-- Botones de Acci√≥n -->
    <div class="flex flex-col sm:flex-row items-stretch sm:items-center justify-end gap-3 md:gap-4 mt-6 md:mt-8 p-4 md:p-6 bg-gray-50 rounded-xl md:rounded-2xl border-2 border-gray-200">
        <a href="{{ url_for('admin.usuarios') }}" class="inline-flex items-center justify-center px-4 md:px-6 py-2.5 md:py-3 bg-white border-2 border-gray-300 rounded-lg md:rounded-xl font-semibold text-gray-700 hover:bg-gray-50 hover:border-gray-400 transition-all duration-200 shadow-sm text-sm md:text-base">
            <i class="fas fa-times mr-2"></i>
            Cancelar
        </a>
        <button type="submit" class="inline-flex items-center justify-center px-6 md:px-8 py-2.5 md:py-3 bg-gradient-to-r from-sena-green to-sena-green-dark hover:from-sena-green-dark hover:to-sena-green-darker text-white font-bold rounded-lg md:rounded-xl transition-all duration-200 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 text-sm md:text-base">
            <i class="fas fa-save mr-2"></i>
            {{ 'Actualizar Usuario' if usuario else 'Crear Usuario' }}
        </button>
    </div>
</form>

<script>
// Toggle activo/inactivo text
document.getElementById('activo').addEventListener('change', function() {
    const label = document.getElementById('toggleLabel');
    label.textContent = this.checked ? 'Usuario Activo' : 'Usuario Inactivo';
});

// Mostrar/ocultar selector de colegio seg√∫n el rol
const rolSelect = document.getElementById('rol');
const colegioDocenteRow = document.getElementById('colegioDocenteRow');
const colegioRectorRow = document.getElementById('colegioRectorRow');

function actualizarCamposColegio() {
    const rolSeleccionado = rolSelect.value;

    // Ocultar todos por defecto
    if (colegioDocenteRow) colegioDocenteRow.style.display = 'none';
    if (colegioRectorRow) colegioRectorRow.style.display = 'none';

    // Mostrar seg√∫n el rol
    if (rolSeleccionado === 'DOCENTE' && colegioDocenteRow) {
        colegioDocenteRow.style.display = 'block';
    } else if (rolSeleccionado === 'RECTOR' && colegioRectorRow) {
        colegioRectorRow.style.display = 'block';
    }
}

// Ejecutar al cargar la p√°gina
if (rolSelect) {
    actualizarCamposColegio();
    rolSelect.addEventListener('change', actualizarCamposColegio);
}

// Filtrar programas por colegio seleccionado
const colegioSelect = document.getElementById('colegio_id');
const programaSelect = document.getElementById('programa_id');

if (colegioSelect && programaSelect) {
    const todosProgramas = Array.from(programaSelect.options).filter(opt => opt.value !== '');

    colegioSelect.addEventListener('change', function() {
        const colegioId = this.value;

        // Limpiar programas
        programaSelect.innerHTML = '<option value="">Sin asignar</option>';

        if (colegioId) {
            // Filtrar programas por colegio
            fetch(`/admin/api/programas-por-colegio/${colegioId}`)
                .then(res => res.json())
                .then(data => {
                    data.programas.forEach(prog => {
                        const option = document.createElement('option');
                        option.value = prog.id;
                        option.textContent = `${prog.nombre} (${prog.codigo})`;
                        programaSelect.appendChild(option);
                    });
                })
                .catch(err => {
                    console.error('Error al cargar programas:', err);
                    // Si falla, mostrar todos
                    todosProgramas.forEach(opt => programaSelect.appendChild(opt.cloneNode(true)));
                });
        } else {
            // Si no hay colegio, mostrar todos los programas
            todosProgramas.forEach(opt => programaSelect.appendChild(opt.cloneNode(true)));
        }
    });
}

// Validar que las contrase√±as coincidan
document.getElementById('usuarioForm').addEventListener('submit', function(e) {
    const password = document.getElementById('password').value;
    const passwordConfirm = document.getElementById('password_confirm').value;

    {% if not usuario %}
    // Para crear usuario, las contrase√±as son obligatorias
    if (password !== passwordConfirm) {
        e.preventDefault();
        alert('‚ùå Las contrase√±as no coinciden. Por favor, verifique e intente nuevamente.');
        document.getElementById('password_confirm').focus();
        return false;
    }
    if (password.length < 6) {
        e.preventDefault();
        alert('‚ùå La contrase√±a debe tener al menos 6 caracteres.');
        document.getElementById('password').focus();
        return false;
    }
    {% else %}
    // Para editar, solo validar si se ingres√≥ una contrase√±a
    if (password || passwordConfirm) {
        if (password !== passwordConfirm) {
            e.preventDefault();
            alert('‚ùå Las contrase√±as no coinciden. Por favor, verifique e intente nuevamente.');
            document.getElementById('password_confirm').focus();
            return false;
        }
        if (password.length < 6) {
            e.preventDefault();
            alert('‚ùå La contrase√±a debe tener al menos 6 caracteres.');
            document.getElementById('password').focus();
            return false;
        }
    }
    {% endif %}
</script>

{% endblock %}
